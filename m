Return-Path: <linux-um-bounces+lists+linux-um=lfdr.de@lists.infradead.org>
X-Original-To: lists+linux-um@lfdr.de
Delivered-To: lists+linux-um@lfdr.de
Received: from bombadil.infradead.org (bombadil.infradead.org [IPv6:2607:7c80:54:e::133])
	by mail.lfdr.de (Postfix) with ESMTPS id 120C610A944
	for <lists+linux-um@lfdr.de>; Wed, 27 Nov 2019 05:06:50 +0100 (CET)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
	d=lists.infradead.org; s=bombadil.20170209; h=Sender:
	Content-Transfer-Encoding:Content-Type:Cc:List-Subscribe:List-Help:List-Post:
	List-Archive:List-Unsubscribe:List-Id:MIME-Version:References:In-Reply-To:
	Subject:To:From:Message-ID:Date:Reply-To:Content-ID:Content-Description:
	Resent-Date:Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:
	List-Owner; bh=m2gmPS/U4VN7Wk2ykUHkEiq4OqwvjXZtlz1SemTk0JQ=; b=ZJghc/EUgSa/2G
	EN5ltJMIKMA0Q038Sz90E4+CFJPOr4ZWOt2jgCWkMFKBEV1Uk1iSH+4ApnZZ/5/B9+s62d1yZIB23
	/j27yyxN/wZsmfeXZREWL1w1V854/tVnxSNy13YfMVPiV7z8ssMK8CJ+FqyXP6I4Y0Lcuq3iute0X
	8MS7Ec3KGgge7GYWmcJaRXEJVtQs/MOmVH16AyQuSerbeW6+iDUKqFvtYKLZFCDJw2RF8PAPmadWD
	q0cwJP+eMFwxB2DkaV5nYULSVdq+Rde5Ucs8PobY+orXo9lxGMSCufXjTsbxYDgGMYo/9q1wTutIQ
	s5OsBzIEnQ5GjwU9cAuA==;
Received: from localhost ([127.0.0.1] helo=bombadil.infradead.org)
	by bombadil.infradead.org with esmtp (Exim 4.92.3 #3 (Red Hat Linux))
	id 1iZob9-0007qP-Fi; Wed, 27 Nov 2019 04:06:39 +0000
Received: from mail-pl1-x642.google.com ([2607:f8b0:4864:20::642])
 by bombadil.infradead.org with esmtps (Exim 4.92.3 #3 (Red Hat Linux))
 id 1iZob4-0007pr-9i
 for linux-um@lists.infradead.org; Wed, 27 Nov 2019 04:06:38 +0000
Received: by mail-pl1-x642.google.com with SMTP id d7so9148703pls.3
 for <linux-um@lists.infradead.org>; Tue, 26 Nov 2019 20:06:28 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=date:message-id:from:to:cc:subject:in-reply-to:references
 :user-agent:mime-version:content-transfer-encoding;
 bh=nWCrWadR1SyGOjV0H+GqNGY+efisuZ1V6ZkGf7TSgNU=;
 b=BK7jI1zdvguVZjIAT90XaFG3dEFHndJTsbUxZz0leQCrmjtkDUEpqvUQYxlSVxC2Y3
 TKECbu1XcDLLfli1zAAJUYFLiubUwQip12mTH6Jz0K1HgqsXn+HBu63Kd3gUgZ3z6+14
 3qML+w0naA7qM7upZrjDTrMReHJk8PUvf1u5iKuOjpsE0rG4iv7e30MZ6jRiv2Va3150
 yYO/wZOVdVC7oouqZlvXISEUw4UaB04qk26OMpgpdyT+LjVEu3WBjWXEhkE21QADIspx
 +WJdjWknIABGZHcbU9xTBgVw3S06EaBw+dnkm6PKPNCIX8fYqky5Ifj5CnuIWbfqcbXr
 3VBQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:date:message-id:from:to:cc:subject:in-reply-to
 :references:user-agent:mime-version:content-transfer-encoding;
 bh=nWCrWadR1SyGOjV0H+GqNGY+efisuZ1V6ZkGf7TSgNU=;
 b=TgIpKh8IaBfvhjEQpC+NYUzBDVW1MOogRi0u9DzbfAuog4zt/wLnwqJ3T09rB56jHN
 foJAKtv9gwZoygxK+RqNGth6+Cs/CAtlnz0kDZY6v1Dmv3Phvv6cEmFRj4U71LvvGq18
 vSQNgHH6Wf8F+ISGBWvPRzXvVXWo/rOIgStDanCkP6yf8hBLUegmpk2LgF48WUvoEtBd
 Dcim1lpJf4AtpmDT1K4AUdf/pi2DONYNRyhptkpGq2F/29Dkrwe6SO+lhN+qlvcGwJyS
 WQHY1UT5V5IBjo/C192xyAR2xrVYWNngYmihO23HQTokifVZ5wa+yTK1QCeMzQzqH2n0
 H27A==
X-Gm-Message-State: APjAAAUWq8Z9Nq1aB3n9FeEiE2g1rvHYgMFVQYTcJaHc3CkaOp2cqTyU
 1mekebxG3Aup5qgA1hsqm7o=
X-Google-Smtp-Source: APXvYqw/oDtif706HC6kg2dNtThDgIUg5At8+AEcw8NUMkR0naS+2ezlpZxeKJc59UJ9FRuHdT/SaQ==
X-Received: by 2002:a17:90a:d352:: with SMTP id
 i18mr3457008pjx.42.1574827587380; 
 Tue, 26 Nov 2019 20:06:27 -0800 (PST)
Received: from earth-mac.local.gmail.com ([202.214.86.179])
 by smtp.gmail.com with ESMTPSA id f10sm13936893pfd.28.2019.11.26.20.06.24
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Tue, 26 Nov 2019 20:06:26 -0800 (PST)
Date: Wed, 27 Nov 2019 13:06:22 +0900
Message-ID: <m2y2w2q7y9.wl-thehajime@gmail.com>
From: Hajime Tazaki<thehajime@gmail.com>
To: anton.ivanov@kot-begemot.co.uk
Subject: Re: [RFC v2 17/37] lkl tools: host lib: virtio devices
In-Reply-To: <ce1a96d4-3d5e-32be-f493-3522fc56a25b@kot-begemot.co.uk>
References: <cover.1573179553.git.thehajime@gmail.com>	<1531c5f16a00b608635c9a62fa3951807075f950.1573179553.git.thehajime@gmail.com>	<CAFLxGvzCwCLbLMhcF6ZJ2afeo7PSd8xLQrU9hRH6YVaMakBSyw@mail.gmail.com>	<de90b04151bafee083727c9769833932788cf428.camel@sipsolutions.net>	<1662825264.98055.1574758225905.JavaMail.zimbra@nod.at>	<4ebb14dc67ccb70543617ce1f7066f3f27cd11a8.camel@sipsolutions.net>	<243342257.98153.1574762974057.JavaMail.zimbra@nod.at>	<98acf77a7c6f6cba7f76c12a850ac2929b9e5a48.camel@sipsolutions.net>	<CAMoF9u3LRC_NaVJzmKPc0+XBxhAqdhnr4-ZzY_ypwQEzUz78yQ@mail.gmail.com>	<ce1a96d4-3d5e-32be-f493-3522fc56a25b@kot-begemot.co.uk>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) Emacs/25.3 Mule/6.0
 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
X-CRM114-Version: 20100106-BlameMichelson ( TRE 0.8.0 (BSD) ) MR-646709E3 
X-CRM114-CacheID: sfid-20191126_200634_341638_4B0366CB 
X-CRM114-Status: GOOD (  26.18  )
X-Spam-Score: 3.9 (+++)
X-Spam-Report: SpamAssassin version 3.4.2 on bombadil.infradead.org summary:
 Content analysis details:   (3.9 points)
 pts rule name              description
 ---- ---------------------- --------------------------------------------------
 -0.0 RCVD_IN_DNSWL_NONE     RBL: Sender listed at https://www.dnswl.org/,
 no trust [2607:f8b0:4864:20:0:0:0:642 listed in]
 [list.dnswl.org]
 0.0 FREEMAIL_FROM          Sender email is commonly abused enduser mail
 provider (thehajime[at]gmail.com)
 -0.0 SPF_PASS               SPF: sender matches SPF record
 0.0 SPF_HELO_NONE          SPF: HELO does not publish an SPF Record
 -0.1 DKIM_VALID_EF          Message has a valid DKIM or DK signature from
 envelope-from domain
 0.1 DKIM_SIGNED            Message has a DKIM or DK signature, not necessarily
 valid
 -0.1 DKIM_VALID Message has at least one valid DKIM or DK signature
 -0.1 DKIM_VALID_AU          Message has a valid DKIM or DK signature from
 author's domain
 2.5 TO_NO_BRKTS_FROM_MSSP  Multiple header formatting problems
 1.6 FROM_MISSP_FREEMAIL    From misspaced + freemail provider
X-BeenThere: linux-um@lists.infradead.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: <linux-um.lists.infradead.org>
List-Unsubscribe: <http://lists.infradead.org/mailman/options/linux-um>,
 <mailto:linux-um-request@lists.infradead.org?subject=unsubscribe>
List-Archive: <http://lists.infradead.org/pipermail/linux-um/>
List-Post: <mailto:linux-um@lists.infradead.org>
List-Help: <mailto:linux-um-request@lists.infradead.org?subject=help>
List-Subscribe: <http://lists.infradead.org/mailman/listinfo/linux-um>,
 <mailto:linux-um-request@lists.infradead.org?subject=subscribe>
Cc: linux-arch@vger.kernel.org, cem@freebsd.org, tavi.purdila@gmail.com,
 richard@nod.at, linux-um@lists.infradead.org, retrage01@gmail.com,
 pscollins@google.com, linux-kernel-library@freelists.org,
 johannes@sipsolutions.net, sigmaepsilon92@gmail.com, liuyuan@google.com
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
Sender: "linux-um" <linux-um-bounces@lists.infradead.org>
Errors-To: linux-um-bounces+lists+linux-um=lfdr.de@lists.infradead.org


On Tue, 26 Nov 2019 19:49:48 +0900,
Anton Ivanov wrote:
> =

> =

> =

> On 26/11/2019 10:42, Octavian Purdila wrote:
> > On Tue, Nov 26, 2019 at 12:16 PM Johannes Berg
> > <johannes@sipsolutions.net> wrote:
> >> =

> >> On Tue, 2019-11-26 at 11:09 +0100, Richard Weinberger wrote:
> >>> ----- Urspr=FCngliche Mail -----
> >>>>> My point is that UML and LKL should try to do use the same concept/=
code
> >>>>> regarding virtio. At the end of day both use virtual devices which =
use
> >>>>> facilities from the host.
> >>>>> If this is really not possible it needs a good explanation.
> >>>> =

> >>>> I think it isn't possible, unless you use vhost-user over a unix dom=
ain
> >>>> socket internally to talk between the kernel (virtio_uml) and hyperv=
isor
> >>>> (device) components.
> >>>> =

> >>>> In virtio_uml, the device implementation is assumed to be a separate
> >>>> process with a vhost-user connection. Here in LKL, the virtio device=
 is
> >>>> part of the "hypervisor", i.e. in the same process.
> >>> =

> >>> Exactly, currently UML and LKL solve same things differently, but do =
we need to?
> >> =

> >> It's not the same thing though :-)
> >> =

> >> UML right now doesn't have or support virtio devices in the built-in
> >> hypervisor, what we wanted to use virtio for was explicitly for the
> >> vhost-user devices.
> >> =

> >> LKL clearly wants to have device implementations in the hypervisor,
> >> perhaps for networking or console etc.? That _might_ be useful since it
> >> makes the device implementation more general, unlike the UML approach
> >> where all devices come with a kernel- and user-side and are special
> >> drivers in the kernel, vs. general virtio drivers.
> >> =

> > =

> > That is correct. Initially we used the same UML model, with dedicated
> > drivers for LKL, and later switched to using the built-in virtio
> > drivers (so far for network and block devices).
> > =

> >> Now, arguably, since UML has all these already a combined UML/LKL
> >> doesn't actually *need* any virtio devices, since all (or at least mos=
t)
> >> of the things that could be covered by virtio today are already covered
> >> by UML devices (block, net, console, random).
> >> =

> >> I'd probably say then that this can be removed from an initial "minimum
> >> viable product" of LKL, since once merged with UML you get the devices
> >> from that. Later, we could decide that UML devices actually are better
> >> done as virtio, and support something like this.
> >> =

> > =

> > I agree, I think it make sense to drop these since the problem of
> > dedicated vs generic / virtio drivers are orthogonal with regard to
> > UML and LKL unification and can later be worked on.
> =

> This brings us back to the interrupt controller as noted by Richard earli=
er.
> =

> UML devices are heavily dependent on the file io as an IRQ trigger
> paradigm and they need an interrupt controller which has an IO event
> feed into it. I did not see that in LKL on first read.

Indeed, the current interrupt model in LKL is not directly associated
with file IO events delivered by epoll family as UML does.  Instead,
calling lkl_trigger_irq() at places will trigger an interrupt in the
LKL case so, we need to adapt somehow if LKL uses UML devices.

> So as a first step we should get it to work with existing UML IRQ
> controller and whatever incremental patches are needed on top of that.

I understand and agree on your comments by all of you.

If implementing LKL with current/existing UML devices is the right
direction, I would go and try to test this approach to verify if this
is doable.

-- Hajime


_______________________________________________
linux-um mailing list
linux-um@lists.infradead.org
http://lists.infradead.org/mailman/listinfo/linux-um
